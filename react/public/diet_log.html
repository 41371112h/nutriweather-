<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NutriWeather</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <header class="site-header" style="
      background: linear-gradient(90deg, #5c7cfa 0%, #40c057 100%);
      padding: 15px 0;
      color: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
  ">
    
    <div class="container header-content" style="
      max-width: 980px; 
      margin: 0 auto; 
      padding: 0 20px; 
      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      
      <div class="header-left">
        <h1 style="margin: 0; color: white; font-size: 1.5rem; font-weight: bold;">NutriWeather</h1>
        <p class="subtitle" style="margin: 0; color: rgba(255,255,255,0.9); font-size: 0.85rem;">æ ¹æ“šå¤©æ°£èˆ‡ä½ çš„ç›®æ¨™æ¨è–¦æ¯å¤©ä¸‰é¤ ğŸ±</p>
      </div>
      
      <nav class="nav" style="display: flex; gap: 12px; align-items: center;">
        <a href="index.html" style="
          text-decoration: none;
          color: rgba(255, 255, 255, 0.9);
          border: 1px solid rgba(255,255,255,0.6); 
          padding: 6px 18px;
          border-radius: 50px;
          font-size: 0.95rem;
          background: rgba(255,255,255,0.15);      
          transition: background 0.2s;
        ">é¦–é </a>

        <a href="diet_log.html" style="
          text-decoration: none;
          color: white;
          border: 2px solid white;       
          padding: 6px 18px;
          border-radius: 50px;
          font-size: 0.95rem;
          font-weight: bold;             
          background: transparent;       
          transition: background 0.2s;
        ">é£²é£Ÿæ—¥è¨˜</a>
      </nav>
    </div>
  </header>

  <main class="main-container" style="max-width: 980px; margin: 40px auto; padding: 0 20px;">
    <div style="margin-bottom: 20px;">
       <h2 class="page-title">ğŸ“ æˆ‘çš„é£²é£Ÿç´€éŒ„æœ¬</h2>
    </div>

    <div class="card">
      <form id="logForm">
        <div class="recommend-box">
            <label class="recommend-label">âœ¨ å¿«é€Ÿå¸¶å…¥ä»Šæ—¥æ¨è–¦èœå–®ï¼š</label>
            <select id="recommendSelect">
                <option value="">-- è®€å–ä¸­... --</option>
            </select>
            <div id="noDataHint">
              (âš ï¸ å°šæœªåœ¨é¦–é ç”Ÿæˆæ¨è–¦è³‡æ–™ï¼Œè«‹å…ˆè‡³é¦–é ç²å–å»ºè­°)
            </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>ç´€éŒ„æ—¥æœŸ (è£œç™»ç”¨)</label>
            <input type="date" id="formDateInput" required>
          </div>
          <div class="form-group">
            <label>é¤åˆ¥</label>
            <select id="mealInput">
              <option value="æ—©é¤">æ—©é¤</option>
              <option value="åˆé¤">åˆé¤</option>
              <option value="æ™šé¤">æ™šé¤</option>
              <option value="é»å¿ƒ">é»å¿ƒ</option>
            </select>
          </div>
          <div class="form-group">
            <label>é£Ÿç‰©åç¨±</label>
            <input type="text" id="foodInput" placeholder="ä¾‹å¦‚ï¼šé›è…¿ä¾¿ç•¶" required>
          </div>
          <div class="form-group">
            <label>ç†±é‡ (kcal)</label>
            <input type="number" id="caloriesInput" placeholder="800" required>
          </div>
        </div>
        <button type="submit" id="submitBtn" class="btn primary-btn">ï¼‹ æ–°å¢</button>
      </form>
    </div>

    <div class="card">
      <div class="history-header">
        <div class="history-controls">
          <h2>æ­·å²ç´€éŒ„æ˜ç´°</h2>
          <input type="date" id="historyDateInput" title="é¸æ“‡è¦æŸ¥çœ‹çš„æ—¥æœŸ">
        </div>
        <span>ç•¶æ—¥ç¸½æ”å–ï¼š<span id="totalDisplay" class="total-kcal">0</span> kcal</span>
      </div>
      
      <div id="loading" class="loading">â³ æ­£åœ¨å¾é›²ç«¯è®€å–è³‡æ–™...</div>

      <div class="log-table-container">
        <table id="logTable">
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th>é¤åˆ¥</th>
              <th>é£Ÿç‰©</th>
              <th>ç†±é‡</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
        <p id="emptyMsg" style="text-align: center; color: #999; margin-top: 20px; display:none;">æš«ç„¡ç´€éŒ„</p>
      </div>
    </div>

    <div class="card">
        <div class="history-header">
            <div class="history-controls">
                <h2>ğŸ“Š ä¸€é€±ç†±é‡çµ±è¨ˆ</h2>
                <input type="date" id="chartDateInput" title="é¸æ“‡è©²é€±çš„ä»»æ„ä¸€å¤©">
            </div>
            <span style="font-size: 0.9rem; color: #666;">é¡¯ç¤ºæ‰€é¸æ—¥æœŸè©²é€± (é€±ä¸€ ~ é€±æ—¥) çš„æ”å–é‡</span>
        </div>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="weekChart"></canvas>
        </div>
    </div>

  </main>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyzR25zI3BButzJDKCcyfmNWBU7tmjNPnXRPzKHXuCyyuT31vra1pQvgNYQx0NXT4-ewg/exec"; 

    let allDietLogs = [];
    let myChart = null; 

    // DOM å…ƒç´ 
    const formDateInput = document.getElementById('formDateInput');
    const historyDateInput = document.getElementById('historyDateInput');
    const chartDateInput = document.getElementById('chartDateInput');

    // --- åˆå§‹åŒ– ---
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    formDateInput.value = todayStr;
    historyDateInput.value = todayStr;
    chartDateInput.value = todayStr; 

    // ç›£è½å™¨
    historyDateInput.addEventListener('change', renderDailyView);
    chartDateInput.addEventListener('change', () => renderWeekChart(chartDateInput.value));

    loadLogsFromSheet();     
    initRecommendDropdown(); 

    // --- è®€å– Google Sheet ---
    function loadLogsFromSheet() {
        if (!GAS_URL) return;
        const loading = document.getElementById('loading');
        const emptyMsg = document.getElementById('emptyMsg');
        
        document.getElementById('logBody').innerHTML = '';
        loading.style.display = 'block';
        emptyMsg.style.display = 'none';

        fetch(`${GAS_URL}?action=getDietLogs`)
            .then(res => res.json())
            .then(json => {
                loading.style.display = 'none';
                if (json.status === 'success') {
                    allDietLogs = json.data;
                } else {
                    allDietLogs = [];
                }
                renderDailyView();
                renderWeekChart(chartDateInput.value);
            })
            .catch(err => {
                loading.style.display = 'none';
                emptyMsg.innerText = "è®€å–å¤±æ•—";
                emptyMsg.style.display = 'block';
                console.error(err);
            });
    }

    // --- æ¸²æŸ“æ¯æ—¥åˆ—è¡¨ ---
    function renderDailyView() {
      const selectedDate = historyDateInput.value; 
      const tbody = document.getElementById('logBody');
      const totalDisplay = document.getElementById('totalDisplay');
      const emptyMsg = document.getElementById('emptyMsg');
      
      tbody.innerHTML = '';
      
      const dailyLogs = allDietLogs.filter(log => log.date === selectedDate);
      
      let total = 0;

      if (dailyLogs.length === 0) {
          emptyMsg.innerText = `ğŸ“… ${selectedDate} å°šç„¡ç´€éŒ„`;
          emptyMsg.style.display = 'block';
      } else {
          emptyMsg.style.display = 'none';
          dailyLogs.forEach(log => {
            const cal = Number(log.calories) || 0;
            total += cal;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${log.date}</td>
              <td>${log.meal}</td>
              <td>${log.food}</td>
              <td style="color:#4263eb; font-weight:bold;">${cal}</td>
            `;
            tbody.appendChild(tr);
          });
      }
      totalDisplay.innerText = total;
    }

    // --- æ¸²æŸ“ä¸€é€±åœ–è¡¨ ---
    function renderWeekChart(selectedDateStr) {
        const selectedDate = new Date(selectedDateStr);
        const day = selectedDate.getDay(); 
        const diff = selectedDate.getDate() - day + (day === 0 ? -6 : 1); 
        
        const monday = new Date(selectedDate.setDate(diff));
        
        const weekDates = [];
        const weekLabels = []; 
        const weekData = [];  
        const weekDaysName = ["é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­", "é€±æ—¥"];

        for (let i = 0; i < 7; i++) {
            const d = new Date(monday);
            d.setDate(monday.getDate() + i);
            const dStr = d.toISOString().split('T')[0];
            weekDates.push(dStr);
            
            const md = (d.getMonth() + 1) + "/" + d.getDate();
            weekLabels.push(`${md} ${weekDaysName[i]}`);
        }

        weekDates.forEach(dateStr => {
            const dailyTotal = allDietLogs
                .filter(log => log.date === dateStr)
                .reduce((sum, log) => sum + (Number(log.calories) || 0), 0);
            weekData.push(dailyTotal);
        });

        const ctx = document.getElementById('weekChart').getContext('2d');

        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: weekLabels,
                datasets: [{
                    label: 'æ¯æ—¥æ”å–ç†±é‡ (kcal)',
                    data: weekData,
                    backgroundColor: weekData.map(val => val > 2500 ? 'rgba(255, 99, 132, 0.7)' : 'rgba(92, 124, 250, 0.7)'),
                    borderColor: weekData.map(val => val > 2500 ? 'rgba(255, 99, 132, 1)' : 'rgba(92, 124, 250, 1)'),
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'å¡è·¯é‡Œ (kcal)' }
                    }
                },
                plugins: {
                    legend: { display: false }, 
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `æ”å–ï¼š${context.raw} kcal`;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- è¡¨å–®é€å‡º ---
    document.getElementById('logForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.innerText;
      const inputDate = formDateInput.value;

      const newLog = {
        date: inputDate,
        meal: document.getElementById('mealInput').value,
        food: document.getElementById('foodInput').value,
        calories: Number(document.getElementById('caloriesInput').value)
      };

      if(GAS_URL) {
        submitBtn.disabled = true;
        submitBtn.innerText = "è³‡æ–™åŒæ­¥ä¸­...";

        fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify(newLog)
        })
        .then(response => response.json())
        .then(data => {
          submitBtn.innerText = "âœ… å„²å­˜æˆåŠŸï¼";
          historyDateInput.value = inputDate;
          chartDateInput.value = inputDate; 
          loadLogsFromSheet();
          
          document.getElementById('foodInput').value = '';
          document.getElementById('caloriesInput').value = '';
          document.getElementById('recommendSelect').value = "";
          
          setTimeout(() => {
             submitBtn.disabled = false;
             submitBtn.innerText = originalText;
          }, 1500);
        })
        .catch((error) => {
          alert("é€£ç·šéŒ¯èª¤");
          submitBtn.disabled = false;
          submitBtn.innerText = originalText;
        });
      } else {
        alert("è«‹è¨­å®š GAS_URL");
      }
    });

    // --- æ¨è–¦é¸å–® ---
    function initRecommendDropdown() {
        const select = document.getElementById('recommendSelect');
        const hint = document.getElementById('noDataHint');
        
        let recipes = [];
        try {
          const cachedData = localStorage.getItem('today_recipes');
          if (cachedData) {
            recipes = JSON.parse(cachedData);
          }
        } catch (e) { console.error(e); }

        select.innerHTML = '';
        select.appendChild(new Option('-- è«‹é¸æ“‡æƒ³åƒçš„æ¨è–¦æ–™ç† --', ''));

        if (recipes.length > 0) {
            recipes.forEach(item => {
                const option = document.createElement('option');
                option.value = JSON.stringify(item); 
                option.textContent = `${item.meal} - ${item.name} (${item.calories} kcal)`;
                select.appendChild(option);
            });
            hint.style.display = 'none';
        } else {
            const option = document.createElement('option');
            option.textContent = '(ç„¡æ¨è–¦è³‡æ–™)';
            option.disabled = true;
            select.appendChild(option);
            hint.style.display = 'block';
        }

        select.addEventListener('change', function() {
            if (this.value) {
                const item = JSON.parse(this.value);
                document.getElementById('foodInput').value = item.name || '';
                document.getElementById('caloriesInput').value = item.calories || '';
                if(item.meal) {
                   const mealSelect = document.getElementById('mealInput');
                   if(item.meal.includes("æ—©")) mealSelect.value = "æ—©é¤";
                   else if(item.meal.includes("åˆ")) mealSelect.value = "åˆé¤";
                   else if(item.meal.includes("æ™š")) mealSelect.value = "æ™šé¤";
                   else if(item.meal.includes("é»") || item.meal.includes("èŒ¶")) mealSelect.value = "é»å¿ƒ";
                }
                document.getElementById('foodInput').style.backgroundColor = "#e7f5ff";
                setTimeout(() => document.getElementById('foodInput').style.backgroundColor = "", 500);
            }
        });
    }
  </script>

</script>
</body>
</html>